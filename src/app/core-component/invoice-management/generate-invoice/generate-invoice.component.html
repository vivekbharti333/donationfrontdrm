<p-toast></p-toast>

<form [formGroup]="invoiceForm"
      (ngSubmit)="submitInvoice()"
      class="invoice-container container my-4">

  <!-- ================= HEADER ================= -->
  <div class="card shadow-sm border-0 mb-4 invoice-header">
    <div class="card-body d-flex justify-content-between align-items-center">

      <div>
        <h2 class="fw-bold text-primary mb-1">INVOICE</h2>
        <div class="text-muted">
          #{{ invoiceForm.get('invoiceNumber')?.value }}
        </div>
      </div>

      <div class="text-end">
        <div class="mb-2">
          <label class="form-label small text-muted">Invoice Date</label>
          <input type="date"
                 class="form-control form-control-sm"
                 formControlName="invoiceDate">
        </div>

        <div>
          <label class="form-label small text-muted">Due Date</label>
          <input type="date"
                 class="form-control form-control-sm"
                 formControlName="dueDate">
        </div>
      </div>

    </div>
  </div>

  <!-- ================= COMPANY SECTION (COMPACT) ================= -->
<div class="card shadow-sm border-0 mb-3 compact-card">
  <div class="card-header bg-white fw-semibold py-2 px-3 small">
    Company Details
  </div>

  <div class="card-body p-3">

    <!-- Company Dropdown -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label small text-muted mb-1">
          Select Company
        </label>

        <select class="form-select form-select-sm"
                formControlName="companyId"
                (change)="onCompanyChange($event)">
          <option value="">-- Select Company --</option>
          <option *ngFor="let invoiceHeader of invoiceHeaderList"
                  [value]="invoiceHeader.id">
            {{ invoiceHeader.companyFirstName }}
            {{ invoiceHeader.companyLastName }}
          </option>
        </select>
      </div>
    </div>

    <!-- Company Info -->
    <div class="border rounded p-2 compact-box">

      <input type="text"
             formControlName="companyName"
             class="form-control form-control-sm border-0 fw-bold p-0 mb-2"
             placeholder="Company Name" />

      <div class="row small">

        <div class="col-md-6 mb-1">
          <strong>GSTIN:</strong>
          <input type="text"
                 formControlName="gstNumber"
                 class="form-control form-control-sm border-0 p-0 d-inline w-auto"
                 placeholder="GST Number"/>
        </div>

        <div class="col-md-6 mb-1">
          <strong>Mobile:</strong>
          <input type="text"
                 formControlName="mobileNo"
                 class="form-control form-control-sm border-0 p-0 d-inline w-auto"
                 placeholder="Mobile Number"/>
        </div>

        <div class="col-md-12 mb-1">
          <strong>Office Address:</strong>
          <textarea rows="1"
                    formControlName="officeAddress"
                    class="form-control form-control-sm border-0 p-0"
                    placeholder="Office Address"></textarea>
        </div>

        <div class="col-md-12 mb-1">
          <strong>Registered Address:</strong>
          <textarea rows="1"
                    formControlName="regAddress"
                    class="form-control form-control-sm border-0 p-0"
                    placeholder="Registered Address"></textarea>
        </div>

        <div class="col-md-6 mb-1">
          <strong>Website:</strong>
          <input type="text"
                 formControlName="website"
                 class="form-control form-control-sm border-0 p-0 d-inline w-auto"
                 placeholder="Website"/>
        </div>

        <div class="col-md-6 mb-1">
          <strong>Email:</strong>
          <input type="email"
                 formControlName="emailId"
                 class="form-control form-control-sm border-0 p-0 d-inline w-auto"
                 placeholder="Email"/>
        </div>

      </div>

    </div>

  </div>
</div>


  <!-- ================= CUSTOMER SECTION (COMPACT) ================= -->
<div class="card shadow-sm border-0 mb-3 compact-card">
 
  <div class="card-body p-3">

    <!-- Customer Dropdown -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label small text-muted mb-1">
          Select Customer
        </label>

        <select class="form-select form-select-sm"
                formControlName="customerId"
                (change)="onCustomerChange($event)">
          <option value="">-- Select Customer --</option>
          <option *ngFor="let customer of customerList"
                  [value]="customer.id">
            {{ customer.customerName }}
          </option>
        </select>
      </div>
    </div>

    <div class="row g-3">

      <!-- BILL TO -->
      <div class="col-md-6">
        <div class="border rounded p-2 h-100 compact-box">

          <h6 class="fw-semibold mb-2 text-primary small">
            Bill To
          </h6>

          <label class="small text-muted mb-1">Customer Name</label>
          <input class="form-control form-control-sm mb-2"
                 formControlName="customerName">

          <label class="small text-muted mb-1">GSTIN</label>
          <input class="form-control form-control-sm mb-2"
                 formControlName="customerGstNumber">

          <label class="small text-muted mb-1">Billing Address</label>
          <textarea rows="2"
                    class="form-control form-control-sm"
                    formControlName="billingAddress"></textarea>

        </div>
      </div>

      <!-- DELIVERY TO -->
      <div class="col-md-6">
        <div class="border rounded p-2 h-100 compact-box">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-semibold text-primary small mb-0">
              Delivery To
            </h6>

            <div class="form-check m-0">
              <input class="form-check-input form-check-input-sm"
                     type="checkbox"
                     id="sameAddress"
                     (change)="syncDeliveryAddress($event)">
              <label class="form-check-label small ms-1">
                Same as Billing
              </label>
            </div>
          </div>

          <label class="small text-muted mb-1">Delivery Address</label>
          <textarea rows="2"
                    class="form-control form-control-sm"
                    formControlName="deliveryAddresses"></textarea>

        </div>
      </div>

    </div>

  </div>
</div>



 <!-- ================= ITEMS ================= -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white fw-semibold d-flex justify-content-between align-items-center">
    <span>Invoice Items</span>
    <button type="button"
            class="btn btn-primary btn-sm px-3"
            (click)="addItem()">+ Add Item</button>
  </div>

  <div class="card-body p-0" formArrayName="items">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Description</th>
            <th class="text-end">Qty</th>
            <th class="text-end">Rate</th>
            <th class="text-center">Tax Type</th>
            <th class="text-center">Tax Rate</th>
            <th class="text-end">Tax Amt</th>
            <th class="text-end">Amount</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let item of items.controls; let i = index"
              [formGroupName]="i">

            <td class="fw-semibold">{{ i + 1 }}</td>

            <td style="min-width:220px;">
              <input class="form-control form-control-sm mb-1"
                     formControlName="productName"
                     placeholder="Product Name">
              <textarea rows="1"
                        class="form-control form-control-sm"
                        formControlName="description"
                        placeholder="Description"></textarea>
            </td>

            <td>
              <input type="number"
                     class="form-control form-control-sm text-end"
                     formControlName="quantity"
                     (input)="calculateTotals()">
            </td>

            <td>
              <input type="number"
                     class="form-control form-control-sm text-end"
                     formControlName="rate"
                     (input)="calculateTotals()">
            </td>

            <td>
              <select class="form-select form-select-sm"
                      formControlName="taxType"
                      (change)="onTaxTypeChange(i)">
                <option value="">No Tax</option>
                <option value="IGST">IGST</option>
                <option value="CGST_SGST">CGST + SGST</option>
              </select>
            </td>

            <!-- Tax Rate Column -->
            <td>
              <ng-container *ngIf="item.get('taxType')?.value === 'IGST'">
                <input type="number"
                       class="form-control form-control-sm text-end"
                       formControlName="igstRate"
                       placeholder="IGST %"
                       (input)="calculateTotals()">
              </ng-container>

              <ng-container *ngIf="item.get('taxType')?.value === 'CGST_SGST'">
                <div class="d-flex gap-1">
                  <input type="number"
                         class="form-control form-control-sm text-end"
                         formControlName="cgstRate"
                         placeholder="CGST %"
                         (input)="calculateTotals()">
                  <input type="number"
                         class="form-control form-control-sm text-end"
                         formControlName="sgstRate"
                         placeholder="SGST %"
                         (input)="calculateTotals()">
                </div>
              </ng-container>
            </td>

            <!-- <td class="text-end">
              {{
                (
                  (+item.get('cgstAmount')?.value || 0) +
                  (+item.get('sgstAmount')?.value || 0) +
                  (+item.get('igstAmount')?.value || 0)
                ) | number:'1.2-2'
              }}
            </td> -->

            <td class="text-end">
  {{ item.get('taxAmount')?.value | number:'1.2-2' }}
</td>



            <td>
              <input class="form-control form-control-sm text-end fw-semibold"
                     formControlName="amount"
                     readonly>
            </td>

            <td>
              <button type="button"
                      class="btn btn-outline-danger btn-sm"
                      (click)="removeItem(i)">✕</button>
            </td>

          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

  <!-- ================= SUMMARY ================= -->
  <div class="row justify-content-end mb-4">
    <div class="col-md-5">

      <div class="card shadow-sm border-0">
        <div class="card-body">

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Subtotal</span>
            <span class="fw-semibold">
              ₹ {{ invoiceForm.get('subtotal')?.value }}
            </span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Total Tax</span>
            <span class="fw-semibold text-secondary">
              ₹ {{
                (invoiceForm.get('cgstAmount')?.value || 0) +
                (invoiceForm.get('sgstAmount')?.value || 0) +
                (invoiceForm.get('igstAmount')?.value || 0)
              }}
            </span>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Discount</span>
            <input type="number"
                   class="form-control form-control-sm text-end w-50"
                   formControlName="discount"
                   (input)="calculateTotals()">
          </div>

          <hr>

          <div class="d-flex justify-content-between fs-5 fw-bold text-primary">
            <span>Grand Total</span>
            <span>
              ₹ {{ invoiceForm.get('totalAmount')?.value }}
            </span>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- ================= PAYMENT DETAILS ================= -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white fw-semibold">
    Payment Details
  </div>

  <div class="card-body">

    <div class="row">

      <!-- Payment Mode -->
      <div class="col-md-4 mb-3">
        <label class="form-label small text-muted">Payment Mode</label>
        <select class="form-select"
                formControlName="paymentMode">
          <option value="ONLINE">Online</option>
          <option value="CASH">Cash</option>
          <option value="CHEQUE">Cheque</option>
          <option value="UPI">UPI</option>
        </select>
      </div>

      <!-- Transaction ID -->
      <div class="col-md-4 mb-3">
        <label class="form-label small text-muted">Transaction ID</label>
        <input type="text"
               class="form-control"
               formControlName="transactionId"
               placeholder="Enter Transaction ID">
      </div>

      <!-- Payment Status -->
      <div class="col-md-4 mb-3">
        <label class="form-label small text-muted">Payment Status</label>
        <select class="form-select"
                formControlName="paymentStatus">
          <option value="UNPAID">Unpaid</option>
          <option value="PAID">Paid</option>
          <option value="PARTIAL">Partial</option>
        </select>
      </div>

    </div>

    <hr>

    <!-- Bank Details Box -->
    <div class="bank-box p-3 rounded bg-light border">

      <h6 class="fw-semibold mb-3 text-secondary">
        Bank Details
      </h6>

      <div class="row small">

        <div class="col-md-6 mb-2">
          <strong>Account Name:</strong> Datfuslab Technologies Pvt. Ltd.
        </div>

        <div class="col-md-6 mb-2">
          <strong>Bank:</strong> HDFC Bank
        </div>

        <div class="col-md-6 mb-2">
          <strong>Account Number:</strong> 123456789012
        </div>

        <div class="col-md-6 mb-2">
          <strong>IFSC Code:</strong> HDFC0001234
        </div>

      </div>

    </div>

  </div>
</div>


  <!-- ================= BUTTON ================= -->
  <div class="text-end">
    <button class="btn btn-success btn-lg px-4 shadow-sm"
            type="submit">
      Generate Invoice
    </button>
  </div>

</form>
